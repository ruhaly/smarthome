package com.changhong.smarthome.phone.store.activity;

import java.util.ArrayList;
import java.util.List;

import android.content.DialogInterface;
import android.content.Intent;
import android.os.Bundle;
import android.os.Message;
import android.util.Log;
import android.util.TypedValue;
import android.view.Gravity;
import android.view.KeyEvent;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.AbsListView;
import android.widget.AbsListView.OnScrollListener;
import android.widget.EditText;
import android.widget.ExpandableListView;
import android.widget.ExpandableListView.OnGroupClickListener;
import android.widget.PopupWindow;
import android.widget.RelativeLayout;
import android.widget.TextView;
import android.widget.TextView.OnEditorActionListener;

import com.changhong.sdk.activity.SuperActivity;
import com.changhong.sdk.entity.BaseAccountInfo;
import com.changhong.smarthome.phone.R;
import com.changhong.smarthome.phone.store.activity.PullRefreshListView.NewScrollerListener;
import com.changhong.smarthome.phone.store.activity.PullRefreshListView.OnRefreshListener;
import com.changhong.smarthome.phone.store.adapter.AllshoppingAdapter;
import com.changhong.smarthome.phone.store.adapter.Expandadapter;
import com.changhong.smarthome.phone.store.entity.StoreConstant;
import com.changhong.smarthome.phone.store.logic.MainLogic;
import com.changhong.smarthome.phone.store.logic.OrderDetailLogic;
import com.changhong.smarthome.phone.store.logic.bean.GoodsColumnGroup;
import com.changhong.smarthome.phone.store.logic.bean.GoodsDetailInfo;
import com.changhong.smarthome.phone.store.logic.bean.PagerBean;
import com.changhong.smarthome.phone.store.tools.StringUtil;
import com.lidroid.xutils.BitmapUtils;
import com.lidroid.xutils.HttpUtils;

public class StoreMainActivity extends SuperActivity implements OnClickListener
{
    private final static String TAG = "MainActivity";
    
    private RelativeLayout radioGroup;
    
    private TextView subMenuBtn;
    
    /**
     * 搜索框
     */
    private EditText searchEdit;
    
    private MainLogic mainLogic;
    
    /**
     * 标题栏
     */
    private StoreTitleItem titleItem;
    
    private AllshoppingAdapter adapter;
    
    private PullRefreshListView listView;
    
    private BitmapUtils mBitmapUtils;
    
    private HttpUtils httpUtils;
    
    private static final int PAGESIZE = 10;
    
    /**
     * 当前页
     */
    private int curPageIndex = 1;
    
    /**
     * 是否正在加载更多
     */
    private boolean isLoadingMore = false;
    
    /**
     * 是否有数据，能够加载更多
     */
    private boolean hasMore = true;
    
    /**
     * 加载模式： 0 第一次 ；1 刷新 ；2 加载更多
     */
    private int mode = 0;
    
    private List<GoodsDetailInfo> goodsDetailInfos;
    
    /**
     * 商品分类列表
     */
    private ExpandableListView expandableListView;
    
    /**
     * 商品分类adapater
     */
    private Expandadapter expandadapter;
    
    /**
     * 商品分类数据
     */
    private List<GoodsColumnGroup> goodsColumnGroups;
    
    /**
     * 保存上次点击的组id
     */
    private int oldIndex = -1;
    
    protected PopupWindow mPopupWindow;
    
    @SuppressWarnings("unchecked")
    public void handleMsg(Message msg)
    {
        super.handleMsg(msg);
        listView.onRefreshComplete();
        listView.showLoadFinish();
        isLoadingMore = false;
        switch (msg.what)
        {
            case StoreConstant.GET_FINDGOODS_SUCCESS:
                if (msg.obj != null)
                {
                    List<GoodsDetailInfo> temp = (List<GoodsDetailInfo>) msg.obj;
                    if (temp.size() > 0)
                    {
                        goodsDetailInfos.clear();
                        goodsDetailInfos.addAll(temp);
                        adapter.notifyDataSetChanged();
                    }
                    else
                    {
                        hasMore = false;
                    }
                }
                break;
            case StoreConstant.GET_FINDGOODS_FAILED:
                showToast(getResources().getString(R.string.error_1));
                break;
            case StoreConstant.GET_FINDGOODS_GET_MORE_SUCCESS:
                if (msg.obj != null)
                {
                    List<GoodsDetailInfo> temp = (List<GoodsDetailInfo>) msg.obj;
                    if (temp.size() > 0)
                    {
                        goodsDetailInfos.addAll(temp);
                        adapter.notifyDataSetChanged();
                    }
                    else
                    {
                        hasMore = false;
                    }
                }
                break;
            case StoreConstant.GET_FINDGOODS_GET_MORE_FAILED:
                showToast(getResources().getString(R.string.error_1));
                break;
            case StoreConstant.GET_FINDGOODSCOLUMN_SUCCESS:
                if (msg.obj != null)
                {
                    List<GoodsColumnGroup> temp = (List<GoodsColumnGroup>) msg.obj;
                    goodsColumnGroups.addAll(temp);
                    expandadapter.notifyDataSetChanged();
                }
                break;
            case StoreConstant.GET_FINDGOODSCOLUMN_FAILED:
                showToast(getResources().getString(R.string.error_1));
                break;
            case StoreConstant.GET_FINDGOODSCOLUMN_NO_DATA:
                showToast(getResources().getString(R.string.store_error_1));
                break;
        }
    };
    
    private void initListener()
    {
        subMenuBtn.setOnClickListener(this);
        
        titleItem.setBackListener(new OnClickListener()
        {
            
            @Override
            public void onClick(View v)
            {
                // TODO Auto-generated method stub
                finish();
            }
        });
        titleItem.setOtherListener(new OnClickListener()
        {
            
            @Override
            public void onClick(View v)
            {
                // TODO Auto-generated method stub
                Intent intent = new Intent(StoreMainActivity.this,
                        OrderManagerActivity.class);
                startActivity(intent);
            }
        });
    }
    
    private void initView()
    {
        titleItem = (StoreTitleItem) findViewById(R.id.main_title);
        
        searchEdit = (EditText) findViewById(R.id.seacrhing_park_et);
        RelativeLayout.LayoutParams searchLayoutParams = (android.widget.RelativeLayout.LayoutParams) searchEdit.getLayoutParams();
        searchLayoutParams.height = ((mainLogic.screenHeight * 74) / 1280);
        searchLayoutParams.width = RelativeLayout.LayoutParams.MATCH_PARENT;
        searchEdit.setLayoutParams(searchLayoutParams);
        searchEdit.setTextSize(TypedValue.COMPLEX_UNIT_PX,
                (mainLogic.screenWidth * 24) / 720);
        searchEdit.setOnEditorActionListener(new OnEditorActionListener()
        {
            @Override
            public boolean onEditorAction(TextView v, int actionId,
                    KeyEvent event)
            {
                if (actionId == 3)
                {
                    
                    String key = searchEdit.getText().toString();
                    if (key != null && !key.equals(""))
                    {
                        Intent intent = new Intent(StoreMainActivity.this,
                                SearchResultActivity.class);
                        intent.putExtra(StoreConstant.SEARCHKEY, key);
                        startActivity(intent);
                    }
                    else
                    {
                        showToast(getResources().getString(R.string.park_place_edit_hint));
                    }
                }
                return true;
            }
        });
        
        radioGroup = (RelativeLayout) findViewById(R.id.radiobutton);
        RelativeLayout.LayoutParams radioGroupParams = (android.widget.RelativeLayout.LayoutParams) radioGroup.getLayoutParams();
        radioGroupParams.height = ((mainLogic.screenHeight * 90) / 1280);
        radioGroupParams.width = RelativeLayout.LayoutParams.MATCH_PARENT;
        radioGroup.setLayoutParams(radioGroupParams);
        
        subMenuBtn = (TextView) findViewById(R.id.tab_btn);
        
        listView = (PullRefreshListView) findViewById(R.id.main_listview);
        listView.setOnRefreshListener(new OnRefreshListener()
        {
            
            @Override
            public void onRefresh()
            {
                // TODO Auto-generated method stub
                refresh();
            }
        });
        //加载更多
        listView.setNewScrollerListener(new NewScrollerListener()
        {
            private boolean isLoadMoreFile = false;
            
            @Override
            public void newScrollChanged(AbsListView view, int scrollState)
            {
                // TODO Auto-generated method stub
                if ((scrollState == OnScrollListener.SCROLL_STATE_IDLE || scrollState == OnScrollListener.SCROLL_STATE_FLING)
                        && isLoadMoreFile)
                {
                    startToLoadMore();
                }
            }
            
            @Override
            public void newScroll(AbsListView view, int firstVisibleItem,
                    int visibleItemCount, int totalItemCount)
            {
                // TODO Auto-generated method stub
                isLoadMoreFile = (firstVisibleItem + visibleItemCount == totalItemCount) ? true
                        : false;
            }
        });
        adapter = new AllshoppingAdapter(getApplicationContext(), mBitmapUtils,
                goodsDetailInfos);
        listView.setAdapter(adapter);
        
        findGoods();
    }
    
    @Override
    public void onClick(View v)
    {
        // TODO Auto-generated method stub
        Intent intent = null;
        switch (v.getId())
        {
            case R.id.btn_back:
                finish();
                break;
            case R.id.btn_ordermanager:
                intent = new Intent(StoreMainActivity.this,
                        OrderManagerActivity.class);
                startActivity(intent);
                break;
            //显示分类菜单
            case R.id.tab_btn:
                showSubMenuView();
                break;
            default:
                break;
        }
    }
    
    private void showSubMenuView()
    {
        View view = getLayoutInflater().inflate(R.layout.clasifyfragment, null);
        //        RelativeLayout rLayout  = (RelativeLayout) view.findViewById(R.id.submenuview); 
        //        RelativeLayout.LayoutParams layoutParams = new RelativeLayout.LayoutParams(
        //                (mainLogic.screenWidth * 326) / 720,
        //                (mainLogic.screenHeight * 708) / 1280);
        //        rLayout.setLayoutParams(layoutParams);
        
        view.setFocusable(true); // 这个很重要color="#7a7a7a"
        view.setFocusableInTouchMode(true);
        expandableListView = (ExpandableListView) view.findViewById(R.id.expandableListView);
//        RelativeLayout.LayoutParams layoutParams = new RelativeLayout.LayoutParams(
//                (mainLogic.screenWidth * 326) / 720,
//                (mainLogic.screenHeight * 708) / 1280);
//        expandableListView.setLayoutParams(layoutParams);
        
        expandableListView.setOnGroupClickListener(new OnGroupClickListener()
        {
            
            @Override
            public boolean onGroupClick(ExpandableListView parent, View v,
                    int groupPosition, long id)
            {
                // TODO Auto-generated method stub
                
                if (oldIndex == groupPosition)
                {
                    oldIndex = -1;
                    expandadapter.setSelected(-1);
                }
                else
                {
                    oldIndex = groupPosition;
                    expandadapter.setSelected(groupPosition);
                }
                
                return false;
            }
        });
        expandadapter = new Expandadapter(this, mBitmapUtils, goodsColumnGroups);
        expandableListView.setAdapter(expandadapter);
        
        showPopupWindow(view,
                findViewById(R.id.tab_btn),
                (mainLogic.screenWidth * 326) / 720,
                (mainLogic.screenHeight * 708) / 1280);
        
        findGoodsColumn();
    }
    
    protected void showPopupWindow(View newView, View parentView,
            int viewWidth, int viewHeight)
    {
        mPopupWindow = new PopupWindow(newView, viewWidth, viewHeight, true);
        mPopupWindow.setFocusable(true);
        mPopupWindow.setBackgroundDrawable(getResources().getDrawable(android.R.color.transparent));
        //        mPopupWindow.setBackgroundDrawable(getResources().getDrawable(R.drawable.sub_menu_bg));
        if (null != parentView)
        {
            int[] location = new int[2];
            parentView.getLocationOnScreen(location);
            mPopupWindow.showAtLocation(parentView,
                    Gravity.NO_GRAVITY,
                    location[0],
                    location[1] + parentView.getHeight());
            mPopupWindow.update();
        }
    }
    
    @Override
    public boolean onKeyDown(int keyCode, KeyEvent event)
    {
        if (keyCode == KeyEvent.KEYCODE_BACK
                && event.getAction() == KeyEvent.ACTION_DOWN)
        {
            finish();
            return true;
        }
        return super.onKeyDown(keyCode, event);
    }
    
    @Override
    public void initData()
    {
        mainLogic = MainLogic.getInstance(getApplicationContext());
        mainLogic.setData(mHandler);
        mBitmapUtils = new BitmapUtils(getApplicationContext());
        httpUtils = new HttpUtils();
        goodsDetailInfos = new ArrayList<GoodsDetailInfo>();
        goodsColumnGroups = new ArrayList<GoodsColumnGroup>();
        
        BaseAccountInfo accountInfo = new BaseAccountInfo();
        
        accountInfo.setAccountId(getIntent().getStringExtra("account"));
        accountInfo.setUserId(getIntent().getStringExtra("userId"));
        accountInfo.setCommunityCode(getIntent().getStringExtra("communtyId"));
        mainLogic.setBaseAccountInfo(accountInfo);
        
        Log.d(TAG, "initData | accountid = " + accountInfo.getAccountId());
        Log.d(TAG, "initData | userId = " + accountInfo.getUserId());
        Log.d(TAG, "initData | communtyId = " + accountInfo.getCommunityCode());
        
        String httpUrl = getIntent().getStringExtra("cbsUrl");
        if (!StringUtil.isNullOrEmpty(httpUrl))
        {
            StoreConstant.URL_STORE = httpUrl + "/msg";
            Log.d(TAG, "initData | StoreConstant.URL_STORE == "
                    + StoreConstant.URL_STORE);
        }
        
        OrderDetailLogic orderDetailLogic = OrderDetailLogic.getInstance(getApplicationContext());
        orderDetailLogic.deliveryAddress = getIntent().getStringExtra("address");
        orderDetailLogic.phone = getIntent().getStringExtra("mobile");
        orderDetailLogic.reallyName = getIntent().getStringExtra("reallyName");
        
        Log.d(TAG, "initData | deliveryAddress = "
                + orderDetailLogic.deliveryAddress);
        Log.d(TAG, "initData | phone = " + orderDetailLogic.phone);
        Log.d(TAG, "initData | reallyName = " + orderDetailLogic.reallyName);
    }
    
    @Override
    public void initLayout(Bundle paramBundle)
    {
        // TODO Auto-generated method stub
        setContentView(R.layout.activity_main);
        initView();
        initListener();
    }
    
    public void findGoodsColumn()
    {
        if (null != goodsColumnGroups && goodsColumnGroups.size() > 0)
        {
            return;
        }
        showProcessDialog(new DialogInterface.OnDismissListener()
        {
            @Override
            public void onDismiss(DialogInterface dialog)
            {
                mainLogic.stopRequest();
            }
        });
        
        mainLogic.sendFindGoodsColumnReq(httpUtils);
    }
    
    private void findGoods()
    {
        if (goodsDetailInfos != null && goodsDetailInfos.size() > 0
                && mode == 0)
        {
            return;
        }
        showProcessDialog(new DialogInterface.OnDismissListener()
        {
            @Override
            public void onDismiss(DialogInterface dialog)
            {
                mainLogic.stopRequest();
            }
        });
        PagerBean pagerBean = new PagerBean();
        pagerBean.setPageId(curPageIndex);
        pagerBean.setPageSize(PAGESIZE);
        mainLogic.sendFindGoodsReq("", "", pagerBean, mode, httpUtils);
    }
    
    /**
     * 刷新
     */
    private void refresh()
    {
        curPageIndex = 1;
        isLoadingMore = true;
        mode = 1;
        findGoods();
    }
    
    /**
     * 加载更多
     */
    protected void startToLoadMore()
    {
        if (hasMore)
        {
            if (!isLoadingMore)
            {
                
                listView.showLoading();
                curPageIndex = curPageIndex + 1;
                isLoadingMore = true;
                mode = 2;
                Log.d(TAG, "startToLoadMore--->");
                findGoods();
            }
        }
    }
    
    @Override
    public void clearData()
    {
        // TODO Auto-generated method stub
        
    }
    
}
